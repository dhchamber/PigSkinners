{% extends "appmain/base.html" %}
{% load static %}
{% load tz %}
{% block title %}Make Picks{% endblock title %}
{% block stylesheet %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/pick_make.css' %}"/>
{% endblock stylesheet %}
{% block content %}
    {% if submitted %}
        <p class="success">Your pick was submitted successfully. Thank you.</p>
    {% else %}
        <div class="row justify-content-md-center">
            <div class="col-sm-12" align="center">
                {% include 'appmain/weeks_sidebar.html' %}
            </div>
        </div>

        <div>
    <!--        class="table-responsive"-->
            {% get_current_timezone as TIMEZONE %}
            <form method="POST" name="frmPicks" action="/pick/make/">
                {% csrf_token %}
                <table id="pick_make" class="table table-bordered table-hover table-sm" data-sortable="true">
    <!--                     data-height="400" >-->
    <!--class="table table-bordered table-hover table-sm"                 -->
                    <thead class="thead-light">
                    <tr>
                        <td colspan="6" align="center"><font size="+1" ><b>Picks for week:  {{ pick.wk.gt }} {{ pick.wk.week_no }}
                            <br>Picks are:
                            {% if pick.wk.closed %}
                                <a class="closed">CLOSED</a>
                            {% else %}
                                <a class=open>OPEN</a>
                            {% endif %}
                            </b></font>
                            <br>
                            {{ pick.wk.start_dt|date:"d M Y" }} to {{ pick.wk.end_dt|date:"d M Y" }} &nbsp;
                            <input type="hidden" name="hidPickID" id="hidPickID" style="color: blue;" value="{{ pick.id }}">
                        </td>
                    </tr>
                    <tr>
                        <td colspan="6" align="center">
                            <font size="+1">For user: {{ pick.user.first_name }}&nbsp;{{ pick.user.last_name }}</font>
                        </td>
                    </tr>
                    <tr dataRow="false">
                        <td colspan="6" align="center">
                            <input type="button" class="btnRandom" id="btnRandom" name="btnRandom" style="color: blue;" value="Select Random Picks" onclick="selectRandomPicks()"
                                {% if pick.wk.closed %}
                                    disabled
                                {% endif %}
                                >
                        </td>
                    </tr>
                    <tr dataRow="false"  align="center">
                        {% if messages %}
                            <td colspan="6">
                            <ul class="messages">
                                {% for message in messages %}
                                    <li class = "{{ message.tags }}">{{ message }}</li>
                                {% endfor %}
                            </ul>
                            </td>
                        {% else %}
                            <td colspan="6">&nbsp;</td>
                        {% endif %}
                    </tr>
                    <tr dataRow="false">
                        <th data-field="game" data-sortable="true" align="center">Game</th>
    <!--                    <td width="15px">&nbsp;</td>-->
                        <th data-field="visitor" data-sortable="true" class="tdVisitorHeader" colspan="2" align="center">Visitor</th>
    <!--                    <td width="15px">&nbsp;</td>-->
                        <th class="tdHomeHeader" colspan="2" align="center">Home</th>
    <!--                    <td width="15px">&nbsp;</td>-->
                        <th data-field="visitor" data-sortable="true" align="center">Time in timezone({{ TIMEZONE }})</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for pick_game in pick.pickgame_set.all %}
                        <tr>
                            <td align="center">{{ forloop.counter }}</td>
    <!--                        <td>&nbsp;&nbsp;</td>-->
                            <td class="tdVisitorContent"><img src="{% static pick_game.game.visitor_team.logo_file_name %}" width="25px" >&nbsp;</td>
                            <td><a class="Game{{ forloop.counter }}" id="Game{{ forloop.counter }}Visitor" href="#" team="{{ pick_game.game.visitor_team.id }}"
                             {% if pick_game.game.visitor_team.id == pick_game.team.id %}
                                   background-color="#ff6600" style="background-color: rgb(255, 102, 0);"
                            {% endif %}
                            ><font color="blue" >{{ pick_game.game.visitor_team.team_name }}</font></a></td>
    <!--                        <td>&nbsp;&nbsp;</td>-->
                            <td><a class="Game{{ forloop.counter }}" id="Game{{ forloop.counter }}Home" href="#" team="{{ pick_game.game.home_team.id }}"
                             {% if pick_game.game.home_team.id == pick_game.team.id %}
                                   background-color="#ff6600" style="background-color: rgb(255, 102, 0);"
                            {% endif %}
                            ><font color="blue">{{ pick_game.game.home_team.team_name }}</font></a></td>
                            <td class="tdHomeContent"><img width="25px" src="{% static pick_game.game.home_team.logo_file_name %}"></td>
    <!--                        <td>&nbsp;</td>-->
                            <td align="center">{{ pick_game.game.day }}&nbsp;{{ pick_game.game.get_date }}
                                <input type="hidden" name="Selected{{ forloop.counter }}" id="Selected{{ forloop.counter }}" style="color: blue;" value="{{ pick_game.team.id }}"></td>
                        </tr>
                    {% endfor %}
                    <tr dataRow="false">
                        <td align="center" colspan="2"><font size="+1" face="wingdings">Ã„</font></td>
                        <td colspan="4" align="left" style="color: blue;">Points Game Total:&nbsp;
                            <input type="text" name="txtPointsTotal" id="txtPointsTotal" style="color: blue;" value="{{ pick.points }}"
                            {% if pick.wk.closed %}
                                readonly
                            {% endif %}
                            >
                        </td>
                    </tr>
                    {% if pick.koth_eligible %}
                        <tr dataRow="false">
                            <td colspan="9" align="center"><font size="+1"><b>King of the Hill pick:</b></font></td>
                        </tr>
                        <tr dataRow="false">
                            <td class = "cboKingOfHillPick" kothEligible = "{{ pick.koth_eligible }}" colspan="9" align="center">
                            {% if pick.wk.closed %}
                                <input type="text" name="txtPointsTotal" style="color: blue;" value="{{ pick.koth_team.team_name }}" readonly >
                            {% else %}
                                <select name="cboKingOfHillPick" id="cboKingOfHillPick" style="color: blue;">
                                    <option value=""></option>
                                    {% for team in pick.koth_remaining %}
                                        <option value="{{ team.id }}" style="color: blue;"
                                        {% if pick.koth_team.id == team.id %}
                                            selected="selected"
                                        {% endif %}
                                        >{{ team.team_name }}</option>
                                    {% endfor %}
                                </select>
                            {% endif %}
                            </td>
                        </tr>
                    {% endif %}
                    <tr dataRow="false">
                        <td colspan="9">
                            <p align="center">{% if pick.saved %}
                                <font size="+1" style="color: white;">Picks SAVED</font>
                            {% else %}
                                <font size="+1" style="color: red;">Picks NOT saved</font>
                                {% endif %}</p>
                        </td>
                    </tr>
                    <tr dataRow="false">
                        <td colspan="9" style="color: blue;" align="center"><input name="btnSavePicks" id="btnSavePicks" type="submit" value="Save Picks"
                        {% if pick.wk.closed %}
                            disabled
                        {% endif %}
                        ></td>
                    </tr>
                    <tr dataRow="false">
                        <td colspan="9" >&nbsp;</td>
                    </tr>
                    </tbody>
                </table>
            </form>
        </div>
    {% endif %}

        {% block script %}
            <script type="text/javascript" language="Javascript" src="{% static 'appmain/js/pick_make.js' %}" > </script>
        {% endblock %}

    <script type="text/javascript" language="Javascript" >
        function selectRandomPicks() {
        var i;
        var sel;

        //randomly select a points game value between 30-60 points, but only if they haven't already have selected something
        var x = $('#txtPointsTotal').val();
        if (!(parseInt(x) > 0)) {
            $('#txtPointsTotal').val(Math.floor((60-29)*Math.random()) + 30);
        }

        //select random KOTH if it's available
        var kothEligible = $('.cboKingOfHillPick').attr('kothEligible');
        if(kothEligible == "True" && frmPicks.cboKingOfHillPick.value == "") {
            var upperLimit = frmPicks.cboKingOfHillPick.options.length - 1;
            frmPicks.cboKingOfHillPick.selectedIndex = Math.floor((upperLimit)*Math.random()) + 1;
        }

        //Select a random pick for each game if there already isn't a pick made
        for (i = 1; i <= 16; i++) {
            selTeam = $('#Selected'.concat(i)).val();
            if(!(parseInt(selTeam) > 0)) {
                //generate a random number and see if it is even or odd, even = HOME team, odd = AWAY team
                var random = Math.floor(Math.random()*101);
                if(random % 2 == 0) {
                    $('#Game'.concat(i).concat('Home')).click();
                } else {
                    $('#Game'.concat(i).concat('Visitor')).click();
                }
            }
        }
        };
    </script>
{% endblock content %}